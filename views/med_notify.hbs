<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="js/rolldate.min.js" type="text/javascript"></script>
    <script src="js/setTime.js" type="text/javascript"></script>
    <link href="css/layout.css" rel="stylesheet">
    <link href="css/pickMed.css" rel="stylesheet">
    <link href="css/medNotify.css" rel="stylesheet">        
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <title>藥物提醒</title>
  </head>
  <body>
  </body>
  <script>
    function Load_medNotify(userId){
      $('body').empty()
      $('body').append(`<div class="wrapper row mx-auto">
                          <div>
                            <div id="medNotify_div">
                            </div>   
                            <div class="blank"></div>
                            <button class="btn btn-dark mx-auto" type="button" id="add">新增藥物</button>
                            <p class="btnHeight"></p> 
                          </div>
                        </div>`)

      $.ajax({
        url: 'get-notify',
        data: {userId: userId},
        success: function (data){
          if(Object.keys(data).length != 0){
            $.each(data, function (key, value){
              $('#medNotify_div').append(`<p class="time">${value.notifyTime.split(':')[0]}:${value.notifyTime.split(':')[1]}</p>
                                          <div class="row row-cols-3 mx-auto px-1 med_div" id="med_div_${value.user_NotifyId}">
                                          </div>
                                          <div class="row justify-content-around mt-2">
                                            <input class="deletebtn col btn shadow" type="button" value="  刪除" del_user_NotifyId="${value.user_NotifyId}">
                                            <input class="editbtn col btn shadow" type="button" value="  編輯">
                                          </div>`)
              $.ajax({
                url: 'get-med-notify',
                data: {user_NotifyId: value.user_NotifyId},
                success: function(data){
                  $.each(data.slice(0,3), function (key, value){
                    $('#med_div_'+value.user_NotifyId).append(`<div class="med-imgs col-sm-3 mt-2 pb-3 px-1">
                                                                <img src="${value.medPicture}">
                                                                <div class="med-name shadow">${value.medName}</div>
                                                              </div>`)
                  })
                }
              })
            })
          }else{
            $('body').empty()
            $('body').append(`<div class="wrapper row mx-auto p-5">
                                <div>
                                  <p class="title">建立藥物提醒</p>
                                  <p>The problem with Realtimevirus scanners is that they're 
                                    inherently heavy on the CPU, 
                                    as they have to hash and comparebr 
                                  </p>
                                  <p class="row justify-content-center mt-1"><img class="col-sm-4" id="landing_img" src="img/notify.png" alt=""></p>
                                  <div class="blank"></div>
                                  <button class="btn btn-dark mx-auto" type="button" id="add">新增提醒</button>
                                </div>
                              </div>`)
          }
        }
      })
      
    }
    function Load_pickMed(userId){
      $.ajax({
        url: 'pick-med',
        data: {
          userId: userId
        },
        success: function (data){
          $('body').empty()
          $('body').append(`<div class="wrapper row mx-auto">
                              <div>
                                  <div class="timeCheck">
                                    <p class="title check">新增提醒時間</p>
                                      <div class="roll-time">
                                        <input type="text" id="hour" name="hour" placeholder="9" value="">
                                        :
                                        <input type="text" id="min" name="min" placeholder="00" value="">
                                    </div>  
                                  </div>                                        
                                  <p class="title">選擇藥物</p>
                                  <div class="pillCheck">
                                    <p id="warning_sentence">請至少選擇一種藥物</p>
                                    <div class="row row-cols-3" id="medDisplay">
                                  </div>
                                  <button class="btn mx-auto" type="button" id="cancelbtn">取消</button>
                                  <button class="btn btn-dark mx-auto" type="button" id="nextbtn">下一步</button>
                                  <button class="btn btn-dark mx-auto" type="button" id="backbtn">重新選擇藥物</button>
                                  <button class="btn btn-dark mx-auto" type="button" id="submitbtn">完成</button>
                                </div>
                              </div>`)
          $.each(data, function (key, value){
            $('#medDisplay').append(`<div class="med-imgs mr-1" id="med_${value.user_MedId}">
                                      <label for="cbox_${value.user_MedId}"><img src="${value.medPicture}"></label> <input class="form-check-input" type="checkbox" value="${value.user_MedId}" id="cbox_${value.user_MedId}">
                                      <div class="med-name shadow">${value.medName}</div>
                                    </div>`)
          })
        }
      })            
    }

    liff.init({
      liffId:'1655949102-QOy7mkzW'
    })
    .then(() => {
      liff.getProfile()
      .then(profile =>{
        $(document).ready(function(){
          Load_medNotify(profile.userId)          
          $('body').on('click', '#add', function(){  
            Load_pickMed(profile.userId)             
          })                    

          $('body').on('click', '#nextbtn', function(){
            $('input[type="checkbox"]').each(function(index) {
                if(!this.checked){
                  $('#med_'+this.value).remove()
                }else{
                  this.style.display = 'none'
                }    
            })
            $('#warning_sentence').css('display','none')
            $('#nextbtn').css('display','none')
            $('#backbtn').css('display','initial')
            $('#submitbtn').css('display','initial')
            $('.timeCheck').css('display', 'initial')
            clock();
          })

          $('body').on('click', '#backbtn', function(){
            Load_pickMed(profile.userId)
          })


          $('body').on('click', '#submitbtn', function(){   
            let user_MedId = []
            $('input[type="checkbox"]').each(function(index) {
                if(this.checked) user_MedId.push(this.value)  
            })             
            $.ajax({
              url: 'create-med-notify',
              data: {
                userId: profile.userId,
                hour: $('#hour').val(),
                min: $('#min').val(),
                user_MedId: user_MedId
              },
              success: function (data){
                $('body').empty()                
              }
            })
          })                 
        
          $('body').on('click', '.deletebtn', function(){
            $.ajax({
              url: 'delete-notify',
              data: {user_NotifyId: $(this).attr('del_user_NotifyId')},
              success: function (data){
                Load_medNotify(profile.userId)
              }
            })
          })

          $('body').on('click', '.editbtn', function(){
            $.ajax({
              url: 'edit-notify',
              data: {},
              success: function (data){
                //$('body').empty()
                Load_pickMed(profile.userId)                
                $('#warning_sentence').css('display','none')
                //$('.timeCheck').css('display', 'initial')


              }
            })
          })   

        })      
        
      })
      .catch((err) => {
        console.log('error:', err)
      })
    })
    .catch(error => {
      //error callback   
    })      
           
  </script>
</html>
